<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PharmaChain Quantum Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Load jsPDF (for PDF reports) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Load FileSaver (for CSV/JSON reports) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        /* Define the Inter font and default dark theme */
        :root {
            --bg-dark: #0a1118;
            --text-light: #e0e7ff;
            --glass-bg: rgba(18, 30, 40, 0.55);
            --glass-border: rgba(255, 255, 255, 0.15);
            --shadow-base: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
            --blue-glow: #3C96FF;
            --purple-glow: #A064FF;
            --cyan-edge: #12D8FA;
            --emerald-accent: #00FFB0;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            transition: background-color 0.5s, color 0.5s;
        }

        /* Light Mode Overrides */
        .light-mode {
            --bg-dark: #f0f4f8;
            --text-light: #1f2937;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(0, 0, 0, 0.1);
        }

        /* Core Glassmorphism Style */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-base);
            border-radius: 12px;
            transition: all 0.3s ease-in-out;
        }

        /* Neon Glow Effects (KPI Cards and important elements) */
        .neon-blue { box-shadow: 0 0 15px var(--blue-glow); }
        .neon-purple { box-shadow: 0 0 15px var(--purple-glow); }
        .neon-cyan { box-shadow: 0 0 15px var(--cyan-edge); }
        .neon-emerald { box-shadow: 0 0 15px var(--emerald-accent); }

        /* KPI Card Hover Effect (Glow expansion) */
        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 0 25px var(--blue-glow);
        }
        .kpi-card.purple:hover { box-shadow: 0 0 25px var(--purple-glow); }
        .kpi-card.cyan:hover { box-shadow: 0 0 25px var(--cyan-edge); }
        .kpi-card.emerald:hover { box-shadow: 0 0 25px var(--emerald-accent); }
        
        /* Utility for glowing text/icons */
        .text-glow-blue { text-shadow: 0 0 8px var(--blue-glow); }
        .text-glow-purple { text-shadow: 0 0 8px var(--purple-glow); }
        .text-glow-cyan { text-shadow: 0 0 8px var(--cyan-edge); }
        .text-glow-emerald { text-shadow: 0 0 8px var(--emerald-accent); }
        
        /* Custom scrollbar for consoles/logs */
        .console-scroll::-webkit-scrollbar { width: 8px; }
        .console-scroll::-webkit-scrollbar-track { background: var(--glass-bg); }
        .console-scroll::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 4px; }
        
        /* Blockchain horizontal scroll and snap effect */
        .blockchain-chain {
            scroll-snap-type: x mandatory;
            overflow-x: auto;
        }
        .blockchain-chain > div {
            scroll-snap-align: center;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 transition-colors duration-500" id="body-theme">

    <!-- Header and Controls -->
    <header class="mb-8 flex flex-col md:flex-row justify-between items-center z-10 sticky top-0 py-4">
        <h1 class="text-3xl font-extrabold tracking-tight text-glow-blue">PharmaChain Quantum</h1>
        
        <div class="flex items-center space-x-4 mt-4 md:mt-0">
            <!-- Role Selector (RBAC) -->
            <select id="role-selector" class="glass p-2 rounded-lg text-sm bg-transparent border-opacity-30 appearance-none">
                <option value="Manufacturer">Manufacturer</option>
                <option value="FDA">FDA</option>
                <option value="Distributor">Distributor</option>
                <option value="Pharmacy">Pharmacy</option>
                <option value="Patient">Patient</option>
            </select>

            <!-- Theme Toggle -->
            <button id="theme-toggle" class="glass p-2 rounded-full hover:scale-105 transition-transform">
                <i data-lucide="moon" id="theme-icon" class="w-5 h-5 text-yellow-300"></i>
            </button>
        </div>
    </header>

    <main class="space-y-8">
        <!-- 1. Dashboard Overview (KPI Cards) -->
        <section id="kpi-overview" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- Total Batches Tracked -->
            <div id="kpi-batches" class="kpi-card glass neon-blue p-6 rounded-xl transition-all duration-300">
                <div class="flex items-center space-x-3">
                    <i data-lucide="blocks" class="w-8 h-8 text-blue-400 text-glow-blue"></i>
                    <p class="text-sm uppercase opacity-70">Batches Tracked</p>
                </div>
                <p class="text-4xl font-bold mt-2" data-kpi="batches">0</p>
            </div>

            <!-- FDA Approvals Completed -->
            <div id="kpi-approvals" class="kpi-card glass neon-purple p-6 rounded-xl transition-all duration-300 purple">
                <div class="flex items-center space-x-3">
                    <i data-lucide="file-check-2" class="w-8 h-8 text-purple-400 text-glow-purple"></i>
                    <p class="text-sm uppercase opacity-70">FDA Approvals</p>
                </div>
                <p class="text-4xl font-bold mt-2" data-kpi="approvals">0</p>
            </div>

            <!-- Active Alerts -->
            <div id="kpi-alerts" class="kpi-card glass neon-cyan p-6 rounded-xl transition-all duration-300 cyan">
                <div class="flex items-center space-x-3">
                    <i data-lucide="alert-triangle" class="w-8 h-8 text-cyan-400 text-glow-cyan"></i>
                    <p class="text-sm uppercase opacity-70">Active Alerts</p>
                </div>
                <p class="text-4xl font-bold mt-2 text-red-400" data-kpi="alerts">0</p>
            </div>

            <!-- Drugs In Transit -->
            <div id="kpi-transit" class="kpi-card glass neon-emerald p-6 rounded-xl transition-all duration-300 emerald">
                <div class="flex items-center space-x-3">
                    <i data-lucide="truck" class="w-8 h-8 text-emerald-400 text-glow-emerald"></i>
                    <p class="text-sm uppercase opacity-70">Drugs In Transit</p>
                </div>
                <p class="text-4xl font-bold mt-2" data-kpi="transit">0</p>
            </div>
        </section>

        <!-- 2. Main Grid: IoT Intelligence and Blockchain Ledger -->
        <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column: IoT Intelligence & AI Insights (2/3 width on desktop) -->
            <div class="lg:col-span-2 space-y-6">
                <!-- IoT Intelligence Module -->
                <div id="iot-module" class="glass p-6">
                    <h2 class="text-xl font-semibold mb-4 text-glow-cyan flex items-center"><i data-lucide="thermometer" class="w-5 h-5 mr-2"></i> Real-Time Environmental Analytics</h2>
                    
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div class="p-3 bg-white/10 rounded-lg text-center">
                            <p class="text-xs uppercase opacity-80">Temperature</p>
                            <p id="iot-temp" class="text-2xl font-bold text-red-300">N/A</p>
                        </div>
                        <div class="p-3 bg-white/10 rounded-lg text-center">
                            <p class="text-xs uppercase opacity-80">Humidity</p>
                            <p id="iot-humidity" class="text-2xl font-bold text-blue-300">N/A</p>
                        </div>
                        <div class="p-3 bg-white/10 rounded-lg text-center">
                            <p class="text-xs uppercase opacity-80">Pressure</p>
                            <p id="iot-pressure" class="text-2xl font-bold text-green-300">N/A</p>
                        </div>
                    </div>

                    <!-- Chart Canvas -->
                    <div class="relative h-64">
                        <canvas id="iot-chart"></canvas>
                    </div>
                </div>

                <!-- AI Insight Cards (Hidden initially) -->
                <div id="ai-insight-panel" class="glass p-4 hidden">
                    <h3 class="text-lg font-semibold mb-3 text-glow-purple flex items-center"><i data-lucide="brain" class="w-5 h-5 mr-2"></i> AI Predictive Insights</h3>
                    <div id="ai-insights" class="space-y-3">
                        <!-- AI Insights will be dynamically inserted here -->
                    </div>
                </div>
            </div>

            <!-- Right Column: Alert & Anomaly Center (1/3 width on desktop) -->
            <div class="lg:col-span-1 space-y-6">
                <!-- AI-Driven Alert & Anomaly Center -->
                <div id="alert-center-module" class="glass p-6 h-full">
                    <h2 class="text-xl font-semibold mb-4 text-glow-red flex items-center"><i data-lucide="bell-ring" class="w-5 h-5 mr-2"></i> Alert & Anomaly Center</h2>
                    
                    <div id="alert-summary" class="grid grid-cols-2 gap-2 mb-4 text-center">
                        <div class="p-2 bg-red-800/50 rounded-lg">Critical: <span id="alert-count-critical" class="font-bold">0</span></div>
                        <div class="p-2 bg-yellow-800/50 rounded-lg">High: <span id="alert-count-high" class="font-bold">0</span></div>
                    </div>
                    
                    <div id="alert-feed" class="console-scroll h-64 overflow-y-auto space-y-3">
                        <!-- Alert cards will be dynamically inserted here -->
                        <p class="text-sm opacity-60 text-center p-4" id="no-alerts-msg">No active alerts. System nominal.</p>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- 3. Blockchain Ledger Visualization -->
        <section id="blockchain-ledger" class="glass p-6">
            <h2 class="text-xl font-semibold mb-4 text-glow-emerald flex items-center"><i data-lucide="git-branch" class="w-5 h-5 mr-2"></i> Blockchain Ledger Visualization</h2>
            
            <div class="flex space-x-4 mb-4">
                <button id="add-block-btn" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i> Simulate Transaction
                </button>
                <button id="verify-chain-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    <i data-lucide="scan" class="w-4 h-4 inline mr-1"></i> Verify Chain Integrity
                </button>
            </div>

            <!-- Horizontal Blockchain Chain -->
            <div id="blockchain-chain" class="blockchain-chain flex space-x-4 p-2 overflow-x-auto">
                <!-- Blocks will be dynamically inserted here -->
            </div>
        </section>

        <!-- 4. Drug Traceability Timeline and Reports/Console -->
        <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
             <!-- Left/Middle Column: Traceability Timeline (2/3 width) -->
            <div class="lg:col-span-2 glass p-6 h-full">
                <h2 class="text-xl font-semibold mb-6 text-glow-purple flex items-center"><i data-lucide="route" class="w-5 h-5 mr-2"></i> Batch Traceability Timeline (BAT-001)</h2>
                <div id="traceability-timeline" class="relative pl-6">
                    <!-- Timeline content will be dynamically inserted here -->
                    <div class="absolute left-0 top-0 h-full w-0.5 bg-purple-500/50 neon-purple"></div>
                </div>
                <p class="text-sm opacity-60 mt-4">Timeline auto-updates with new blockchain events.</p>
            </div>
            
            <!-- Right Column: Reports & Console (1/3 width) -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Reports & Compliance Module -->
                <div id="reports-module" class="glass p-6">
                    <h2 class="text-xl font-semibold mb-4 text-glow-blue flex items-center"><i data-lucide="bar-chart-3" class="w-5 h-5 mr-2"></i> Reports & Compliance</h2>
                    <div class="space-y-2">
                        <button onclick="generateReport('pdf')" class="w-full text-left bg-blue-700/50 hover:bg-blue-600/70 p-2 rounded-lg transition-colors flex items-center justify-between"><i data-lucide="file-text" class="w-4 h-4 mr-2"></i> FDA Compliance Audit (.pdf)</button>
                        <button onclick="generateReport('csv')" class="w-full text-left bg-blue-700/50 hover:bg-blue-600/70 p-2 rounded-lg transition-colors flex items-center justify-between"><i data-lucide="file-spreadsheet" class="w-4 h-4 mr-2"></i> IoT Dataset Export (.csv)</button>
                        <button onclick="generateReport('json')" class="w-full text-left bg-blue-700/50 hover:bg-blue-600/70 p-2 rounded-lg transition-colors flex items-center justify-between"><i data-lucide="file-json" class="w-4 h-4 mr-2"></i> Blockchain History Log (.json)</button>
                    </div>
                </div>

                <!-- System Log Console -->
                <div id="console-module" class="glass p-6">
                    <h2 class="text-xl font-semibold mb-4 text-glow-cyan flex items-center"><i data-lucide="terminal" class="w-5 h-5 mr-2"></i> System Log Console</h2>
                    <div id="system-console" class="console-scroll h-40 overflow-y-auto text-xs bg-black/50 p-2 rounded-lg">
                        <!-- Logs will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </section>

    </main>
    
    <!-- Modal for Block Inspection -->
    <div id="block-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
        <div class="glass p-6 w-11/12 max-w-lg rounded-xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-glow-emerald">Block Inspector</h3>
                <button onclick="toggleModal('block-modal', false)" class="text-lg opacity-70 hover:opacity-100">&times;</button>
            </div>
            <pre id="modal-json-content" class="bg-black/50 p-4 rounded-lg overflow-x-auto text-xs"></pre>
        </div>
    </div>

    <!-- Alert Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2">
        <!-- Toasts will be dynamically inserted here -->
    </div>


    <script>
        // --- GLOBAL CONFIGURATION AND STATE ---
        
        const COLORS = {
            blue: '#3C96FF',
            purple: '#A064FF',
            cyan: '#12D8FA',
            emerald: '#00FFB0',
            red: '#FF4D4D',
            yellow: '#FFC107'
        };

        const ROLES = ['Manufacturer', 'FDA', 'Distributor', 'Pharmacy', 'Patient'];

        let systemState = {
            isDark: true,
            role: 'Manufacturer',
            kpis: { batches: 1, approvals: 0, alerts: 0, transit: 1 },
            iot: {
                temp: [],
                humidity: [],
                pressure: [],
                timestamps: [],
                anomalyCount: 0
            },
            blockchain: [],
            alerts: [],
            anomalyTimeout: null,
            traceabilityData: {
                'REGISTERED': { title: 'Batch Registered', icon: 'factory', color: 'blue', actor: 'Manufacturer' },
                'APPROVED': { title: 'FDA Approved', icon: 'shield-check', color: 'purple', actor: 'FDA' },
                'TRANSFER': { title: 'Transit Started', icon: 'truck', color: 'cyan', actor: 'Distributor' },
                'CONSUMED': { title: 'Dispensed to Patient', icon: 'user', color: 'emerald', actor: 'Pharmacy' },
                'SENSOR_ALERT': { title: 'Sensor Anomaly Logged', icon: 'alert-triangle', color: 'red', actor: 'System' },
            },
            // Initial batch data for traceability
            batchTrace: [
                { type: 'REGISTERED', timestamp: new Date(Date.now() - 3600000).toISOString(), actor: 'Manufacturer' },
                { type: 'TRANSFER', timestamp: new Date(Date.now() - 1800000).toISOString(), actor: 'Distributor' },
            ]
        };

        // --- DOM ELEMENTS (Cached for performance) ---
        const $ = (id) => document.getElementById(id);
        const $body = $('body-theme');
        const $themeToggle = $('theme-toggle');
        const $themeIcon = $('theme-icon');
        const $roleSelector = $('role-selector');
        const $kpiSection = $('kpi-overview');
        const $iotModule = $('iot-module');
        const $blockchainLedger = $('blockchain-ledger');
        const $alertCenter = $('alert-center-module');
        const $reportsModule = $('reports-module');
        const $timeline = $('traceability-timeline');
        const $console = $('system-console');
        const $aiInsightPanel = $('ai-insight-panel');
        const $aiInsights = $('ai-insights');
        const $alertFeed = $('alert-feed');
        const $noAlertsMsg = $('no-alerts-msg');

        let iotChart;
        
        // --- INDEXEDDB SETUP (Persistence) ---
        const DB_NAME = 'PharmaChainDB';
        const DB_VERSION = 1;
        const STORE_THEME = 'themeStore';
        const STORE_IOT = 'iotStore';
        const STORE_BLOCKCHAIN = 'blockchainStore';

        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_THEME)) db.createObjectStore(STORE_THEME);
                    if (!db.objectStoreNames.contains(STORE_IOT)) db.createObjectStore(STORE_IOT);
                    if (!db.objectStoreNames.contains(STORE_BLOCKCHAIN)) db.createObjectStore(STORE_BLOCKCHAIN);
                };

                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => { console.error("IndexedDB error:", event.target.error); reject(event.target.error); };
            });
        }

        async function idbSet(storeName, key, val) {
            try {
                const db = await openDatabase();
                const tx = db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                store.put(val, key);
                return tx.complete;
            } catch (error) {
                console.error(`IDB Set failed for ${key}:`, error);
            }
        }

        async function idbGet(storeName, key) {
            try {
                const db = await openDatabase();
                const tx = db.transaction(storeName, 'readonly');
                const store = tx.objectStore(storeName);
                const request = store.get(key);
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            } catch (error) {
                console.error(`IDB Get failed for ${key}:`, error);
                return null;
            }
        }

        // --- UTILITY FUNCTIONS ---

        /** Converts a string to SHA-256 hash using Web Crypto API. */
        async function sha256(str) {
            const buffer = new TextEncoder().encode(str);
            const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        /** Formats date to a readable string. */
        function formatTime(isoString) {
            return new Date(isoString).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
        }

        /** Toggles visibility of a modal element. */
        function toggleModal(id, show) {
            const modal = $(id);
            if (modal) {
                modal.classList.toggle('hidden', !show);
                modal.classList.toggle('flex', show);
            }
        }

        /** Appends a message to the system log console. */
        function log(prefix, message, color = 'text-white') {
            const timestamp = formatTime(new Date().toISOString());
            const logEntry = document.createElement('p');
            logEntry.className = `p-1 ${color} font-mono text-xs opacity-80`;
            logEntry.innerHTML = `<span class="opacity-60">[${timestamp}]</span> <span class="font-bold">[${prefix}]</span> ${message}`;
            $console.appendChild(logEntry);
            $console.scrollTop = $console.scrollHeight; // Auto-scroll
        }

        /** Creates and shows a temporary alert toast. */
        function showToast(message, type = 'info') {
            const colors = {
                info: 'bg-blue-600',
                success: 'bg-emerald-600',
                warning: 'bg-yellow-600',
                error: 'bg-red-600'
            };
            const container = $('toast-container');
            const toast = document.createElement('div');
            toast.className = `${colors[type]} text-white p-3 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 flex items-center`;
            toast.innerHTML = `<i data-lucide="bell" class="w-5 h-5 mr-2"></i> ${message}`;
            
            lucide.createIcons();
            container.appendChild(toast);
            
            // Fade in and out
            setTimeout(() => toast.classList.add('opacity-100'), 10);
            setTimeout(() => toast.classList.remove('opacity-100'), 5000);
            setTimeout(() => toast.remove(), 5300);
        }

        // --- THEME MANAGEMENT ---

        function applyTheme(isDark) {
            systemState.isDark = isDark;
            $body.classList.toggle('light-mode', !isDark);
            const iconName = isDark ? 'moon' : 'sun';
            const iconColor = isDark ? 'text-yellow-300' : 'text-yellow-600';
            $themeIcon.setAttribute('data-lucide', iconName);
            $themeIcon.className = `w-5 h-5 ${iconColor}`;
            lucide.createIcons(); // Re-render icon
            
            // Update Chart gradient colors based on theme
            if (iotChart) {
                const gradientColor = isDark ? 'rgba(18, 216, 250, 0.4)' : 'rgba(100, 100, 255, 0.4)';
                iotChart.data.datasets.forEach(dataset => {
                    dataset.backgroundColor = (ctx) => {
                        const gradient = ctx.chart.ctx.createLinearGradient(0, 0, 0, 200);
                        gradient.addColorStop(0, gradientColor);
                        gradient.addColorStop(1, 'rgba(0,0,0,0)');
                        return gradient;
                    };
                });
                iotChart.options.scales.x.grid.color = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                iotChart.options.scales.y.grid.color = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                iotChart.options.scales.x.ticks.color = isDark ? 'white' : 'black';
                iotChart.options.scales.y.ticks.color = isDark ? 'white' : 'black';
                iotChart.update();
            }

            idbSet(STORE_THEME, 'isDark', isDark);
        }

        function setupThemeToggle() {
            $themeToggle.addEventListener('click', () => applyTheme(!systemState.isDark));
            
            // Initial load from IndexedDB
            idbGet(STORE_THEME, 'isDark').then(isDark => {
                if (isDark !== null) {
                    applyTheme(isDark);
                } else {
                    applyTheme(true); // Default to dark if no setting found
                }
            });
        }

        // --- KPI AND UI RENDERING ---

        function updateKPIs() {
            Object.keys(systemState.kpis).forEach(key => {
                const element = document.querySelector(`[data-kpi="${key}"]`);
                if (element) {
                    element.textContent = systemState.kpis[key];
                    // Pulse animation on update
                    element.classList.add('animate-pulse', 'duration-500');
                    setTimeout(() => element.classList.remove('animate-pulse', 'duration-500'), 500);
                }
            });
        }

        function updateAlertSummary() {
            const criticalCount = systemState.alerts.filter(a => a.severity === 'CRITICAL').length;
            const highCount = systemState.alerts.filter(a => a.severity === 'HIGH').length;

            $('alert-count-critical').textContent = criticalCount;
            $('alert-count-high').textContent = highCount;
            systemState.kpis.alerts = criticalCount + highCount;
            updateKPIs();
        }

        // --- RBAC MANAGEMENT ---

        function applyRBAC(role) {
            systemState.role = role;
            log('SYS', `Role changed to ${role}`, 'text-blue-300');
            
            // Set visibility based on role (simple example)
            // Only FDA/Manufacturer/Distributor see reports module
            const reportsVisible = ['FDA', 'Manufacturer', 'Distributor'].includes(role);
            $reportsModule.classList.toggle('hidden', !reportsVisible);

            // Only Manufacturer can manually add blocks (simulate transaction)
            $('add-block-btn').classList.toggle('hidden', role !== 'Manufacturer');

            // Only Pharmacy/Patient are interested in immediate traceability
            const timelineTitle = role === 'Patient' ? 'Verify Drug Legitimacy (QR Scan)' : 'Batch Traceability Timeline (BAT-001)';
            const timelineIcon = role === 'Patient' ? 'scan-line' : 'route';
            const timelineHeader = $timeline.closest('.glass').querySelector('h2');
            
            if (timelineHeader) {
                timelineHeader.innerHTML = `<i data-lucide="${timelineIcon}" class="w-5 h-5 mr-2"></i> ${timelineTitle}`;
                lucide.createIcons();
            }

            // AI Insight is visible only to operational roles
            $aiInsightPanel.classList.toggle('hidden', ['Patient', 'Pharmacy'].includes(role));
            
            renderAlertFeed();
        }

        // --- IOT INTELLIGENCE MODULE ---

        function initIoTChart() {
            const ctx = $('iot-chart').getContext('2d');
            const gradientColor = systemState.isDark ? 'rgba(18, 216, 250, 0.4)' : 'rgba(100, 100, 255, 0.4)';

            iotChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: systemState.iot.timestamps.map(() => ''), // Time labels will be added later
                    datasets: [{
                        label: 'Temperature (°C)',
                        data: systemState.iot.temp,
                        borderColor: COLORS.cyan,
                        backgroundColor: (ctx) => {
                            const gradient = ctx.chart.ctx.createLinearGradient(0, 0, 0, 200);
                            gradient.addColorStop(0, gradientColor);
                            gradient.addColorStop(1, 'rgba(0,0,0,0)');
                            return gradient;
                        },
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: 'origin',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 500 },
                    scales: {
                        x: {
                            type: 'linear',
                            ticks: { callback: (val, index) => systemState.iot.timestamps[index], color: systemState.isDark ? 'white' : 'black' },
                            grid: { color: systemState.isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' }
                        },
                        y: {
                            min: 0, max: 50,
                            title: { display: true, text: 'Value', color: systemState.isDark ? 'white' : 'black' },
                            ticks: { color: systemState.isDark ? 'white' : 'black' },
                            grid: { color: systemState.isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        /** Simulates sensor data, checks for anomalies, and updates charts/state. */
        function simulateIoTData() {
            // Function to generate data around a base value with controlled drift
            const drift = (base, maxDev, driftFactor) => {
                const last = systemState.iot.temp.length > 0 ? systemState.iot.temp.slice(-1)[0] : base;
                return Math.min(Math.max(last + (Math.random() - 0.5) * driftFactor, base - maxDev), base + maxDev);
            };

            // Temperature (Target: 5°C, Range: 2-8°C) - simulating a slow upward drift for a potential AI alert
            let temp = drift(5, 4, 0.2); 
            // Humidity (Target: 50%, Range: 30-70%)
            let humidity = drift(50, 25, 0.5);
            // Pressure (Target: 1005 hPa, Range: 990-1020 hPa)
            let pressure = drift(1005, 20, 0.8);

            // Hardcode a critical breach every 10 updates for demonstration
            if (systemState.iot.temp.length % 15 === 0 && systemState.iot.temp.length > 0) {
                temp = 11.5; // Critical temp breach
                log('IOT', 'Simulating a critical temperature breach.', 'text-red-400');
            }

            const timestamp = new Date();
            
            // Keep data arrays clean (max 20 points)
            systemState.iot.temp.push(temp);
            systemState.iot.humidity.push(humidity);
            systemState.iot.pressure.push(pressure);
            systemState.iot.timestamps.push(formatTime(timestamp.toISOString()));

            if (systemState.iot.temp.length > 20) {
                ['temp', 'humidity', 'pressure', 'timestamps'].forEach(key => systemState.iot[key].shift());
            }

            // 1. Check Anomaly Rules
            let isAnomaly = false;
            let anomalyType = '';

            if (temp < 2 || temp > 8) { isAnomaly = true; anomalyType = 'Temperature'; }
            else if (humidity < 30 || humidity > 70) { isAnomaly = true; anomalyType = 'Humidity'; }
            else if (pressure < 990 || pressure > 1020) { isAnomaly = true; anomalyType = 'Pressure'; }

            if (isAnomaly) {
                handleAnomaly(anomalyType, temp, humidity, pressure);
            } else {
                // 2. AI Pre-emptive Insight (Simulated)
                // If temp is rising fast and above 7.5°C, predict risk
                if (temp > 7.5 && systemState.iot.temp.slice(-2).length === 2 && temp - systemState.iot.temp.slice(-2)[0] > 0.3) {
                    renderAIInsight(`Container REF-07 trending +${(temp - systemState.iot.temp.slice(-2)[0]).toFixed(1)}°C/update. Recommend cooling boost by 12%.`, 'HIGH');
                } else if ($aiInsights.children.length > 0) {
                    // Simple cleanup of insights if conditions normalize
                    $aiInsights.innerHTML = '';
                    $aiInsights.closest('.glass').classList.add('hidden');
                }
            }


            // 3. Update UI and Chart
            $('iot-temp').textContent = `${temp.toFixed(1)}°C`;
            $('iot-humidity').textContent = `${humidity.toFixed(1)}%`;
            $('iot-pressure').textContent = `${pressure.toFixed(1)} hPa`;
            
            iotChart.data.labels = systemState.iot.timestamps;
            iotChart.data.datasets[0].data = systemState.iot.temp;
            iotChart.update('none'); // 'none' for instant update without animation

            // 4. Persist Data
            idbSet(STORE_IOT, 'data', { temp: systemState.iot.temp, humidity: systemState.iot.humidity, pressure: systemState.iot.pressure, timestamps: systemState.iot.timestamps });
        }
        
        // --- ANOMALY & ALERT MANAGEMENT ---

        function handleAnomaly(type, temp, humidity, pressure) {
            // Prevent multiple alerts for the same continuous breach
            if (systemState.anomalyTimeout) return;

            systemState.iot.anomalyCount++;
            const alertId = `ALERT-${systemState.iot.anomalyCount}`;
            const severity = 'CRITICAL';
            const logType = type === 'Temperature' ? 'Temp' : type;
            const value = type === 'Temperature' ? temp.toFixed(1) : (type === 'Humidity' ? humidity.toFixed(1) : pressure.toFixed(1));
            const safeMax = type === 'Temperature' ? '8°C' : (type === 'Humidity' ? '70%' : '1020 hPa');
            
            const newAlert = {
                id: alertId,
                severity: severity,
                type: `${type} Breach`,
                batch: 'BAT-001',
                currentValue: value,
                safeMax: safeMax,
                timestamp: new Date().toISOString(),
                aiInsight: `Increase refrigeration by 15% and log action.`,
                isResolved: false
            };
            systemState.alerts.unshift(newAlert);
            
            log('ALERT', `CRITICAL: ${type} breach detected (${value}) in BAT-001. Logging to ledger.`, 'text-red-400');
            showToast(`CRITICAL: ${type} Breach Detected!`, 'error');

            renderAlertFeed();
            updateAlertSummary();
            
            // Add block to ledger
            addBlock('SENSOR_ALERT', 'System', { type: type, value: value, alertId: alertId });

            // Set a timeout to prevent re-alerting immediately
            systemState.anomalyTimeout = setTimeout(() => {
                systemState.anomalyTimeout = null;
                log('SYS', 'Anomaly check re-enabled.', 'text-yellow-400');
            }, 30000); // 30 seconds

            // Render AI insight card immediately
            renderAIInsight(`CRITICAL BREACH: ${type} at ${value}. Max safe is ${safeMax}.`, severity);
        }
        
        function renderAIInsight(message, severity) {
            $aiInsights.closest('.glass').classList.remove('hidden');
            $aiInsights.innerHTML = ''; // Clear previous insights
            
            const color = severity === 'CRITICAL' ? 'bg-red-800/20 text-red-300' : 'bg-yellow-800/20 text-yellow-300';
            
            const insightCard = document.createElement('div');
            insightCard.className = `p-3 rounded-lg border border-opacity-30 border-${severity.toLowerCase()}-500 ${color} flex items-start`;
            insightCard.innerHTML = `<i data-lucide="alert-triangle" class="w-5 h-5 mr-3 flex-shrink-0"></i> 
                                    <p class="text-sm">${message}</p>`;
            $aiInsights.appendChild(insightCard);
            lucide.createIcons();
        }

        function renderAlertFeed() {
            $alertFeed.innerHTML = '';
            $noAlertsMsg.classList.toggle('hidden', systemState.alerts.length > 0);

            systemState.alerts.forEach(alert => {
                const color = alert.severity === 'CRITICAL' ? 'bg-red-900/40 text-red-300 neon-red' : 'bg-yellow-900/40 text-yellow-300';
                const icon = alert.severity === 'CRITICAL' ? 'zap' : 'bell';

                const alertCard = document.createElement('div');
                alertCard.className = `glass p-3 rounded-lg border-l-4 border-red-500 ${color} transition-all duration-300`;
                alertCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <p class="text-sm font-bold flex items-center">
                            <i data-lucide="${icon}" class="w-4 h-4 mr-2"></i> ${alert.severity}: ${alert.type}
                        </p>
                        <span class="text-xs opacity-70">${formatTime(alert.timestamp)}</span>
                    </div>
                    <p class="text-xs mt-1 opacity-90">Batch: ${alert.batch} | Current: ${alert.currentValue}</p>
                    <p class="text-xs italic mt-1 text-red-200">AI Insight → ${alert.aiInsight}</p>
                    <button class="resolve-alert-btn mt-2 text-xs bg-emerald-700 hover:bg-emerald-600 px-2 py-1 rounded transition-colors" data-id="${alert.id}">Resolve</button>
                `;
                $alertFeed.appendChild(alertCard);
            });
            lucide.createIcons();

            document.querySelectorAll('.resolve-alert-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const alertId = e.target.getAttribute('data-id');
                    resolveAlert(alertId);
                });
            });
        }
        
        function resolveAlert(alertId) {
            const alertIndex = systemState.alerts.findIndex(a => a.id === alertId);
            if (alertIndex !== -1) {
                const resolvedAlert = systemState.alerts.splice(alertIndex, 1)[0];
                log('ALERT', `Alert ${alertId} resolved. Logging action to ledger.`, 'text-emerald-400');
                showToast(`Alert ${alertId} Resolved.`, 'success');
                
                // Add resolution block
                addBlock('RESOLVED', systemState.role, { alertId: alertId, details: `Anomaly resolved by ${systemState.role}.` });

                renderAlertFeed();
                updateAlertSummary();
            }
        }

        // --- BLOCKCHAIN LEDGER ---

        function renderBlockchain() {
            const $chain = $('blockchain-chain');
            $chain.innerHTML = '';
            
            systemState.blockchain.forEach((block, index) => {
                const isGenesis = index === 0;
                const blockCard = document.createElement('div');
                
                let glowClass = 'neon-cyan';
                if (block.data.type === 'APPROVED') glowClass = 'neon-purple';
                if (block.data.type === 'SENSOR_ALERT') glowClass = 'neon-red';
                if (block.data.type === 'RESOLVED') glowClass = 'neon-emerald';

                blockCard.className = `block-card glass ${glowClass} p-4 rounded-xl flex-shrink-0 w-64 md:w-80 cursor-pointer hover:shadow-xl transition-all duration-300`;
                blockCard.setAttribute('data-index', index);
                
                // Tamper check (simple verification)
                const isVerified = block.currentHash === block.computedHash;
                const verificationGlow = isVerified ? '' : 'border-red-500 border-2 animate-pulse';

                blockCard.innerHTML = `
                    <div class="space-y-2 ${verificationGlow}">
                        <p class="text-xs font-semibold uppercase opacity-80">${block.data.type} (${block.data.actor})</p>
                        <p class="text-sm font-mono break-all">Hash: <span class="text-yellow-300">${block.currentHash.substring(0, 10)}...</span></p>
                        <p class="text-xs">Prev Hash: ${isGenesis ? '0' : block.previousHash.substring(0, 10)}...</p>
                        <p class="text-xs opacity-70">${formatTime(block.timestamp)}</p>
                        ${!isVerified ? '<p class="text-red-400 font-bold">TAMPERED!</p>' : ''}
                    </div>
                `;
                
                // Add right arrow connector (unless it's the last block)
                if (index < systemState.blockchain.length - 1) {
                    const connector = document.createElement('div');
                    connector.className = 'flex items-center justify-center text-4xl text-cyan-400 font-extralight';
                    connector.innerHTML = '&#8594;'; // Right arrow
                    $chain.appendChild(blockCard);
                    $chain.appendChild(connector);
                } else {
                    $chain.appendChild(blockCard);
                }
            });

            // Scroll to the end to show the latest block
            $chain.scrollLeft = $chain.scrollWidth;

            // Add listener for modal
            document.querySelectorAll('.block-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const index = e.currentTarget.getAttribute('data-index');
                    showBlockDetails(systemState.blockchain[index]);
                });
            });
            
            // Persist blockchain data
            idbSet(STORE_BLOCKCHAIN, 'ledger', systemState.blockchain);
            renderTraceabilityTimeline();
        }

        async function createBlock(data, previousHash = '0') {
            const timestamp = new Date().toISOString();
            const blockContent = JSON.stringify({ data, previousHash, timestamp });
            const currentHash = await sha256(blockContent);
            return {
                timestamp,
                data,
                previousHash,
                currentHash,
                // Store the computed hash separately for easy verification
                computedHash: currentHash
            };
        }

        async function addBlock(type, actor, metadata = {}) {
            const lastBlock = systemState.blockchain.slice(-1)[0];
            const previousHash = lastBlock ? lastBlock.currentHash : '0';

            const data = { type, actor, batch: 'BAT-001', ...metadata };
            const newBlock = await createBlock(data, previousHash);
            
            // Tamper Simulation (for verification demo): occasionally corrupt a hash on add
            if (Math.random() < 0.05 && systemState.blockchain.length > 0) {
                newBlock.currentHash = await sha256('TAMPERED' + newBlock.currentHash);
                log('BC', `WARNING: Tamper simulation applied to new block!`, 'text-red-500');
            }

            systemState.blockchain.push(newBlock);
            log('BC', `New Block [${type}] added. Hash: ${newBlock.currentHash.substring(0, 10)}...`, 'text-emerald-300');
            
            // Update traceability only for standard events
            if (['REGISTERED', 'APPROVED', 'TRANSFER', 'CONSUMED'].includes(type)) {
                systemState.batchTrace.push({ type, timestamp: newBlock.timestamp, actor });
                systemState.kpis.batches = systemState.batchTrace.filter(t => t.type === 'REGISTERED').length;
                systemState.kpis.approvals = systemState.batchTrace.filter(t => t.type === 'APPROVED').length;
                systemState.kpis.transit = systemState.batchTrace.filter(t => t.type === 'TRANSFER').length;
            }
            updateKPIs();
            renderBlockchain();
        }

        async function verifyChainIntegrity() {
            log('SYS', 'Starting full Blockchain integrity verification...', 'text-blue-300');
            let isChainValid = true;

            for (let i = systemState.blockchain.length - 1; i >= 0; i--) {
                const currentBlock = systemState.blockchain[i];
                const blockContent = JSON.stringify({ data: currentBlock.data, previousHash: currentBlock.previousHash, timestamp: currentBlock.timestamp });
                const calculatedHash = await sha256(blockContent);

                // 1. Check current hash validity
                if (currentBlock.currentHash !== calculatedHash) {
                    log('BC', `SECURITY ALERT: Block #${i} hash mismatch! TAMPERING DETECTED!`, 'text-red-500');
                    isChainValid = false;
                }
                
                // 2. Check previous hash link
                if (i > 0) {
                    const previousBlock = systemState.blockchain[i - 1];
                    if (currentBlock.previousHash !== previousBlock.currentHash) {
                        log('BC', `SECURITY ALERT: Block #${i} link broken! Previous hash mismatch.`, 'text-red-500');
                        isChainValid = false;
                    }
                }
                
                currentBlock.computedHash = calculatedHash; // Recalculate and store for rendering
            }
            
            if (isChainValid) {
                log('SYS', 'Blockchain verification successful. No tampering detected.', 'text-emerald-300');
                showToast('Blockchain Integrity Verified: SECURE', 'success');
            } else {
                showToast('CRITICAL: Tampering Detected!', 'error');
            }

            renderBlockchain(); // Re-render to show red pulses/messages
        }

        // --- TRACEABILITY TIMELINE ---

        function renderTraceabilityTimeline() {
            $timeline.innerHTML = '<div class="absolute left-0 top-0 h-full w-0.5 bg-purple-500/50 neon-purple"></div>'; // Reset and keep the line
            
            // Filter traceability events based on current blockchain data
            const blocks = systemState.blockchain.filter(b => b.data.type !== 'SENSOR_ALERT' && b.data.type !== 'RESOLVED');

            blocks.forEach((block, index) => {
                const eventConfig = systemState.traceabilityData[block.data.type] || { title: 'Unknown Event', icon: 'help-circle', color: 'gray', actor: 'Unknown' };
                const eventDiv = document.createElement('div');
                
                eventDiv.className = 'relative mb-8 pl-8 last:mb-0';
                eventDiv.innerHTML = `
                    <!-- Connector Dot -->
                    <div class="absolute left-0 top-1 w-4 h-4 rounded-full bg-purple-600 border-2 border-purple-300 z-10 -ml-2 text-white flex items-center justify-center">
                        <i data-lucide="${eventConfig.icon}" class="w-3 h-3 text-white"></i>
                    </div>
                    
                    <!-- Content Card -->
                    <div class="glass p-3 rounded-lg hover:shadow-xl transition-all duration-300 cursor-pointer" onclick="showBlockDetails(systemState.blockchain[${index}])">
                        <p class="text-sm font-semibold">${eventConfig.title}</p>
                        <p class="text-xs opacity-70">Actor: ${eventConfig.actor} | ${new Date(block.timestamp).toLocaleDateString()}</p>
                        <p class="text-xs mt-1 italic text-cyan-300">Hash: ${block.currentHash.substring(0, 10)}...</p>
                    </div>
                `;
                $timeline.appendChild(eventDiv);
            });
            lucide.createIcons();
        }

        // --- MODAL AND REPORT FUNCTIONS ---
        
        function showBlockDetails(block) {
            const $modalContent = $('modal-json-content');
            $modalContent.textContent = JSON.stringify(block, null, 2);
            toggleModal('block-modal', true);
        }

        function generateReport(type) {
            log('SYS', `Generating ${type.toUpperCase()} report...`, 'text-blue-300');
            showToast(`Generating ${type.toUpperCase()} Report...`, 'info');

            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `PharmaChain_Quantum_${type}_${timestamp}.${type}`;

            if (type === 'json') {
                const jsonContent = JSON.stringify(systemState.blockchain, null, 2);
                const blob = new Blob([jsonContent], { type: 'application/json' });
                saveAs(blob, filename);
            } else if (type === 'csv') {
                // Simple CSV for IoT data
                const header = 'Timestamp,Temperature(C),Humidity(%),Pressure(hPa)\n';
                const rows = systemState.iot.timestamps.map((t, i) => 
                    `${t},${systemState.iot.temp[i]},${systemState.iot.humidity[i]},${systemState.iot.pressure[i]}`
                ).join('\n');
                const csvContent = header + rows;
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                saveAs(blob, filename);
            } else if (type === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(18);
                doc.text("FDA Compliance Audit Report (PharmaChain Quantum)", 14, 22);
                
                doc.setFontSize(11);
                doc.text(`Generated By: ${systemState.role}`, 14, 30);
                doc.text(`Date: ${new Date().toLocaleString()}`, 14, 36);

                let y = 50;
                doc.setFontSize(14);
                doc.text("Blockchain Audit Trail", 14, y);
                y += 5;
                doc.line(14, y, 196, y); // Separator line
                y += 7;

                systemState.blockchain.forEach((block, index) => {
                    const status = block.currentHash === block.computedHash ? "VERIFIED" : "TAMPERED";
                    doc.setFontSize(10);
                    doc.text(`[Block ${index}] ${block.data.type} by ${block.data.actor}`, 14, y);
                    doc.text(`Hash: ${block.currentHash.substring(0, 20)}...`, 14, y + 4);
                    doc.text(`Status: ${status}`, 150, y);
                    y += 8;
                    if (y > 280) { // New page if needed
                        doc.addPage();
                        y = 10;
                    }
                });

                doc.save(filename);
            }
        }


        // --- INITIALIZATION AND LIFECYCLE ---
        
        async function initialize() {
            // 1. Initial UI Setup & Persistence
            lucide.createIcons();
            setupThemeToggle();
            
            // 2. Load IoT and Blockchain Data from IndexedDB
            const savedIoT = await idbGet(STORE_IOT, 'data');
            if (savedIoT) {
                systemState.iot = { ...systemState.iot, ...savedIoT };
                log('SYS', `Loaded ${systemState.iot.timestamps.length} historical IoT points from IndexedDB.`, 'text-blue-300');
            }
            
            const savedBlockchain = await idbGet(STORE_BLOCKCHAIN, 'ledger');
            if (savedBlockchain && savedBlockchain.length > 0) {
                systemState.blockchain = savedBlockchain;
                log('SYS', `Loaded ${systemState.blockchain.length} blocks from IndexedDB.`, 'text-blue-300');
            } else {
                // If no blockchain data, create the Genesis block and initial transactions
                await addBlock('REGISTERED', 'Manufacturer', { batchSize: 5000 });
                await addBlock('APPROVED', 'FDA', { approvalID: 'FDA-2025-Q3' });
                await addBlock('TRANSFER', 'Distributor', { carrier: 'SwiftLogistics' });
            }

            // 3. Setup Chart, Blockchain, and Timeline
            initIoTChart();
            renderBlockchain();
            renderTraceabilityTimeline();
            updateKPIs();
            
            // 4. Set Event Listeners
            $roleSelector.addEventListener('change', (e) => applyRBAC(e.target.value));
            $('add-block-btn').addEventListener('click', () => addBlock('TRANSFER', systemState.role, { note: `Manual Sim by ${systemState.role}` }));
            $('verify-chain-btn').addEventListener('click', verifyChainIntegrity);

            // 5. Apply initial RBAC based on default role
            applyRBAC(systemState.role);

            // 6. Start IoT Simulation Loop
            simulateIoTData(); // Run once immediately
            setInterval(simulateIoTData, 5000); // Update every 5 seconds (as requested)

            log('SYS', 'PharmaChain Quantum Dashboard initialized successfully.', 'text-emerald-300');
        }

        window.onload = initialize;

    </script>
</body>
</html>