<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PharmaChain Secure Logistics Dashboard</title>
    <!-- Load Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Load Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <!-- Load Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }
        #sidebar {
            width: 250px;
            min-height: 100vh;
            background: #ffffff;
            transition: all 0.3s;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
        }
        .main-content {
            margin-left: 250px;
            padding-top: 20px;
            padding-bottom: 20px;
        }
        /* Mobile adjustments */
        @media (max-width: 992px) {
            #sidebar {
                margin-left: -250px;
            }
            #sidebar.open {
                margin-left: 0;
            }
            .main-content {
                margin-left: 0;
            }
        }

        /* KPI Card Styling */
        .kpi-card {
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .kpi-card:hover {
            transform: translateY(-2px);
        }
        .kpi-icon {
            font-size: 2rem;
            color: #495057;
        }

        /* Log Viewer */
        #logViewer {
            max-height: 250px;
            overflow-y: scroll;
            font-size: 0.8rem;
            background-color: #212529;
            color: #f8f9fa;
            border-radius: 0.5rem;
            padding: 10px;
            font-family: monospace;
        }
        #logViewer div.info { color: #6c757d; }
        #logViewer div.warn { color: #ffc107; }

        /* Timeline Modal Styling */
        #modalTimeline {
            list-style: none;
            padding: 0;
            margin: 0;
            position: relative;
        }
        #modalTimeline > li {
            padding-left: 40px;
            position: relative;
        }
        .step-dot {
            position: absolute;
            left: 0;
            top: 10px;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            display: block;
            border: 2px solid #ffffff;
            box-shadow: 0 0 0 2px #adb5bd;
        }
        #modalTimeline > li:not(:last-child)::before {
            content: '';
            position: absolute;
            left: 5px;
            top: 22px;
            bottom: -8px;
            width: 2px;
            background-color: #dee2e6;
        }
        .text-xxs {
            font-size: 0.65rem;
        }
    </style>
</head>
<body>

    <!-- Top Navbar for Mobile Toggle -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom d-lg-none sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand text-primary fw-bold" href="#">PharmaChain</a>
            <button class="btn btn-primary" id="toggleSidebar">
                <i class="bi bi-list"></i>
            </button>
            <span class="badge bg-danger rounded-pill ms-2" id="notifyCount">0</span>
        </div>
    </nav>

    <!-- Sidebar -->
    <div id="sidebar" class="d-none d-lg-block">
        <div class="d-flex flex-column h-100 p-3">
            <h5 class="text-primary fw-bold mb-4">
                <i class="bi bi-box-seam-fill me-2"></i>PharmaChain
            </h5>
            <div class="mb-3 border-bottom pb-3">
                <div class="small text-muted">Current Role:</div>
                <div class="fw-bold mb-2 d-flex align-items-center">
                    <i class="bi bi-person-circle me-2"></i><span id="roleTop">FDA</span>
                </div>
                <select class="form-select form-select-sm" id="roleSwitcher">
                    <option value="FDA">FDA</option>
                    <option value="Manufacturer" selected>Manufacturer</option>
                    <option value="Distributor">Distributor</option>
                    <option value="Pharmacy">Pharmacy</option>
                </select>
            </div>
            <ul class="nav nav-pills flex-column mb-auto" id="navLinks">
                <li class="nav-item"><a href="#" class="nav-link active" data-section="overview"><i class="bi bi-speedometer2 me-2"></i>Overview</a></li>
                <li><a href="#" class="nav-link link-dark" data-section="traceability"><i class="bi bi-truck me-2"></i>Traceability</a></li>
                <li><a href="#" class="nav-link link-dark" data-section="iot"><i class="bi bi-cpu me-2"></i>IoT Monitoring</a></li>
                <li><a href="#" class="nav-link link-dark" data-section="approvals"><i class="bi bi-file-earmark-check me-2"></i>Approvals</a></li>
                <li><a href="#" class="nav-link link-dark" data-section="alerts"><i class="bi bi-bell-fill me-2"></i>Alerts <span class="badge bg-danger rounded-pill ms-auto" id="notifyCount">0</span></a></li>
                <li><a href="#" class="nav-link link-dark" data-section="reports"><i class="bi bi-download me-2"></i>Reports</a></li>
                <li><a href="#" class="nav-link link-dark" data-section="log"><i class="bi bi-journal-text me-2"></i>System Log</a></li>
            </ul>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content p-4">
        <header class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 fw-light">Dashboard</h1>
        </header>

        <!-- === SECTION: OVERVIEW === -->
        <section id="section-overview" class="section">
            <div class="row g-4 mb-4">
                <!-- KPI 1: Total Batches -->
                <div class="col-sm-6 col-lg-3">
                    <div class="card kpi-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-muted small">Total Batches</div>
                                    <h2 class="card-title display-6 fw-bold text-dark" id="kpiBatches">0</h2>
                                </div>
                                <i class="bi bi-boxes kpi-icon text-primary"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- KPI 2: Approvals/Awaiting -->
                <div class="col-sm-6 col-lg-3">
                    <div class="card kpi-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-muted small" id="kpiLabelApprovals">Batches Awaiting QA</div>
                                    <h2 class="card-title display-6 fw-bold text-warning" id="kpiApprovals">0</h2>
                                </div>
                                <i class="bi bi-hourglass-split kpi-icon text-warning"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- KPI 3: Pending Alerts -->
                <div class="col-sm-6 col-lg-3">
                    <div class="card kpi-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-muted small">Pending Alerts</div>
                                    <h2 class="card-title display-6 fw-bold text-danger" id="kpiAlerts">0</h2>
                                </div>
                                <i class="bi bi-exclamation-triangle-fill kpi-icon text-danger"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- KPI 4: In Transit -->
                <div class="col-sm-6 col-lg-3">
                    <div class="card kpi-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-muted small" id="kpiLabelTransit">Shipments Dispatched</div>
                                    <h2 class="card-title display-6 fw-bold text-success" id="kpiTransit">0</h2>
                                </div>
                                <i class="bi bi-geo-alt-fill kpi-icon text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-white fw-semibold border-bottom-0">Latest Alerts</div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush" id="alertsList">
                                <!-- Alerts rendered here -->
                            </ul>
                            <button class="btn btn-sm btn-link mt-2" onclick="setActiveSection('alerts')">View All Alerts</button>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-white fw-semibold border-bottom-0">Live Temperature Trend (Selected Batch)</div>
                        <div class="card-body">
                            <canvas id="tempChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- === SECTION: TRACEABILITY === -->
        <section id="section-traceability" class="section d-none">
            <h2 class="h4 mb-3">Batch Traceability Ledger</h2>
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center bg-white">
                    <div class="input-group" style="max-width: 300px;">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" placeholder="Search by ID, Manufacturer, or Status" id="traceSearch">
                    </div>
                    <span class="text-muted small">Total batches: <span id="tracePagerInfo"></span></span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="sortable" data-key="batchId">Batch ID <i class="bi bi-sort-alpha-down"></i></th>
                                    <th class="sortable" data-key="manufacturer">Manufacturer</th>
                                    <th class="sortable" data-key="status">Status</th>
                                    <th class="sortable" data-key="location">Location</th>
                                    <th class="sortable" data-key="timestamp">Last Update <i class="bi bi-sort-down-alt"></i></th>
                                </tr>
                            </thead>
                            <tbody id="traceTableBody">
                                <!-- Rows rendered here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer d-flex justify-content-between align-items-center bg-white">
                    <div class="d-flex align-items-center">
                        <span class="me-2 small text-muted">Page Size:</span>
                        <select class="form-select form-select-sm" style="width: 80px;" id="tracePageSize">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                        </select>
                    </div>
                    <div>
                        <button class="btn btn-outline-secondary btn-sm" id="tracePrev"><i class="bi bi-chevron-left"></i> Previous</button>
                        <button class="btn btn-outline-secondary btn-sm" id="traceNext">Next <i class="bi bi-chevron-right"></i></button>
                    </div>
                </div>
            </div>
        </section>

        <!-- === SECTION: IOT MONITORING === -->
        <section id="section-iot" class="section d-none">
            <h2 class="h4 mb-3">Real-time IoT Sensor Feed</h2>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-white fw-semibold">Temperature (°C)</div>
                        <div class="card-body">
                            <canvas id="tempChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-white fw-semibold">Humidity (%)</div>
                        <div class="card-body">
                            <canvas id="humidChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-white fw-semibold">Pressure (hPa)</div>
                        <div class="card-body">
                            <canvas id="pressChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="alert alert-info mt-4 small">
                <i class="bi bi-info-circle me-1"></i>This chart is simulated and auto-generates a critical alert if the temperature falls outside the 2°C to 8°C range.
            </div>
        </section>

        <!-- === SECTION: APPROVALS === -->
        <section id="section-approvals" class="section d-none">
            <h2 class="h4 mb-3">Regulatory Approval History</h2>
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th>Batch ID</th>
                                    <th>Requester</th>
                                    <th>Status</th>
                                    <th>Timestamp</th>
                                </tr>
                            </thead>
                            <tbody id="approvalHistory">
                                <!-- Rows rendered here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- === SECTION: ALERTS === -->
        <section id="section-alerts" class="section d-none">
            <h2 class="h4 mb-3">Active & Historical System Alerts</h2>
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-end align-items-center bg-white">
                    <div class="input-group" style="max-width: 200px;">
                        <span class="input-group-text small">Filter:</span>
                        <select class="form-select form-select-sm" id="alertsFilter">
                            <option value="Pending" selected>Pending</option>
                            <option value="Resolved">Resolved</option>
                            <option value="All">All</option>
                        </select>
                    </div>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush" id="alertsList">
                        <!-- Alerts rendered here -->
                    </ul>
                </div>
            </div>
        </section>

        <!-- === SECTION: REPORTS === -->
        <section id="section-reports" class="section d-none">
            <h2 class="h4 mb-3">Downloadable Compliance & Data Reports</h2>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card kpi-card">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-file-earmark-spreadsheet me-2 text-success"></i>Shipment Summary (CSV)</h5>
                            <p class="card-text small text-muted">Export current traceability ledger data including batch location and status.</p>
                            <button class="btn btn-sm btn-outline-success w-100" id="btnDownloadShipments">Download CSV</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card kpi-card">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-file-earmark-code me-2 text-info"></i>IoT Metrics Log (JSON)</h5>
                            <p class="card-text small text-muted">Retrieve the full log of real-time temperature, humidity, and pressure data.</p>
                            <button class="btn btn-sm btn-outline-info w-100" id="btnDownloadIot">Download JSON</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card kpi-card">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-file-earmark-text me-2 text-primary"></i>Compliance Report (TXT)</h5>
                            <p class="card-text small text-muted">Generate a snapshot of overall compliance metrics and active issues.</p>
                            <button class="btn btn-sm btn-outline-primary w-100" id="btnDownloadCompliance">Generate Report</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- === SECTION: SYSTEM LOG === -->
        <section id="section-log" class="section d-none">
            <h2 class="h4 mb-3">System Operation Log</h2>
            <div id="logViewer">
                <!-- Log messages rendered here -->
            </div>
        </section>

    </div>

    <!-- Batch Detail Modal -->
    <div class="modal fade" id="batchModal" tabindex="-1" aria-labelledby="batchModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="batchModalLabel">Batch Detail: <span id="modalBatchId" class="text-primary"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-6">
                            <div class="text-muted small">Manufacturer</div>
                            <div class="fw-semibold" id="modalManufacturer"></div>
                        </div>
                        <div class="col-6">
                            <div class="text-muted small">Current Status</div>
                            <div class="fw-semibold" id="modalStatus"></div>
                        </div>
                    </div>
                    <hr>
                    <h6 class="mb-3">Blockchain History Timeline</h6>
                    <ul class="list-group list-group-flush" id="modalTimeline">
                        <!-- Timeline steps rendered here -->
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
/* PharmaChain Dashboard – Interactive Demo Logic (no backend required) */
/* Uses Bootstrap + Chart.js already loaded in index.html */

(function(){
  // ---------- Helpers ----------
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const fmtTime = (d=new Date()) =>
    d.toISOString().replace('T',' ').substring(0,19);

  const log = (msg, level='info') => {
    const el = $('#logViewer');
    const line = document.createElement('div');
    line.className = level;
    line.textContent = [${fmtTime()}] ${msg};
    el.prepend(line);
  };

  const toast = (msg, variant='primary') => {
    // Lightweight toast via Bootstrap Alerts inserted temporarily
    const wrap = document.createElement('div');
    wrap.className = alert alert-${variant} shadow-sm border py-2 px-3 position-fixed top-0 end-0 m-3;
    wrap.style.zIndex = 1080;
    wrap.textContent = msg;
    document.body.appendChild(wrap);
    setTimeout(()=>wrap.classList.add('show'), 10);
    setTimeout(()=>{ wrap.remove(); }, 2800);
  };

  // ---------- Demo Data ----------
  const batches = [
    { batchId:'BAT-001', manufacturer:'Global Meds', status:'In Transit', location:'Los Angeles, US',  timestamp:'2025-11-04 18:12:20' },
    { batchId:'BAT-002', manufacturer:'Zenith Labs', status:'FDA Approved', location:'Newark, US',    timestamp:'2025-11-05 09:22:41' },
    { batchId:'BAT-003', manufacturer:'Acme Pharma', status:'Awaiting Approval', location:'Austin, US', timestamp:'2025-11-03 11:08:10' },
    { batchId:'BAT-004', manufacturer:'Medikon',     status:'At Pharmacy', location:'Phoenix, US',     timestamp:'2025-11-05 12:33:01' },
    { batchId:'BAT-005', manufacturer:'Acme Pharma', status:'In Transit',  location:'San Jose, US',    timestamp:'2025-11-05 16:50:55' },
    { batchId:'BAT-006', manufacturer:'Global Meds', status:'Registered',  location:'Dallas, US',      timestamp:'2025-11-02 10:19:47' },
    { batchId:'BAT-007', manufacturer:'Biotex',      status:'In Transit',  location:'Denver, US',      timestamp:'2025-11-05 19:02:14' },
    { batchId:'BAT-008', manufacturer:'Zenith Labs', status:'Awaiting Approval', location:'Miami, US', timestamp:'2025-11-01 08:44:30' },
    { batchId:'BAT-009', manufacturer:'Medikon',     status:'FDA Approved', location:'Chicago, US',    timestamp:'2025-11-05 07:17:22' },
    { batchId:'BAT-010', manufacturer:'Biotex',      status:'Registered', location:'Raleigh, US',      timestamp:'2025-11-03 13:06:59' },
    { batchId:'BAT-011', manufacturer:'Acme Pharma', status:'In Transit', location:'Sacramento, US',   timestamp:'2025-11-05 21:14:03' },
    { batchId:'BAT-012', manufacturer:'Global Meds', status:'At Pharmacy', location:'Seattle, US',     timestamp:'2025-11-04 14:31:18' },
  ];

  const approvalHistory = [
    { batchId:'BAT-002', requester:'Zenith Labs', status:'Approved', timestamp:'2025-11-05 09:22:41' },
    { batchId:'BAT-009', requester:'Medikon',     status:'Approved', timestamp:'2025-11-05 07:17:22' },
    { batchId:'BAT-003', requester:'Acme Pharma', status:'Pending',  timestamp:'2025-11-03 11:08:10' },
    { batchId:'BAT-008', requester:'Zenith Labs', status:'Pending',  timestamp:'2025-11-01 08:44:30' },
  ];

  let alerts = [
    { id:1, severity:'Critical', status:'Pending', title:'Temperature Breach', detail:'BAT-001 at 11.2°C (>8°C).', when:'2025-11-05 11:25:30' },
    { id:2, severity:'High',     status:'Pending', title:'Unauthorized Location', detail:'BAT-005 left geo-fence corridor.', when:'2025-11-04 18:01:12' },
    { id:3, severity:'Medium',   status:'Resolved', title:'Intermittent Sensor', detail:'BAT-007 humidity sensor reconnect.', when:'2025-11-03 13:10:03' },
  ];

  // ---------- KPI Rendering ----------
  function renderKpis(){
    $('#kpiBatches').textContent = batches.length.toString();
    const pendingApprovals = approvalHistory.filter(a=>a.status==='Pending').length
      + batches.filter(b=>b.status==='Awaiting Approval').length;
    $('#kpiApprovals').textContent = pendingApprovals.toString();
    $('#kpiAlerts').textContent = alerts.filter(a=>a.status==='Pending').length.toString();
    $('#kpiTransit').textContent = batches.filter(b=>b.status==='In Transit').length.toString();
    $$('#notifyCount').forEach(el => el.textContent = $('#kpiAlerts').textContent);
  }

  // ---------- Navigation ----------
  function setActiveSection(id){
    $$('.section').forEach(s => s.classList.add('d-none'));
    $(#section-${id}).classList.remove('d-none');
    $$('#navLinks a').forEach(a=>{
      a.classList.remove('active', 'link-dark');
      a.classList.add('link-dark'); // Ensure link-dark is present by default
      if(a.dataset.section===id){
        a.classList.add('active');
        a.classList.remove('link-dark');
      }
    });
  }

  // Sidebar toggle (mobile)
  $('#toggleSidebar')?.addEventListener('click', ()=> $('#sidebar').classList.toggle('open'));
  // Close sidebar on nav click (mobile)
  $$('#navLinks a').forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      setActiveSection(a.dataset.section);
      $('#sidebar').classList.remove('open');
      log(Mapsd to ${a.textContent.trim()});
    });
  });

  // ---------- Traceability Table (search/sort/paginate) ----------
  let traceSortKey = 'timestamp';
  let traceSortDir = 'desc';
  let tracePage = 1;
  let tracePageSize = parseInt($('#tracePageSize').value,10) || 10;
  let traceQuery = '';

  function getFilteredBatches(){
    const q = traceQuery.toLowerCase().trim();
    let rows = batches.filter(b=>{
      if(!q) return true;
      return [b.batchId,b.manufacturer,b.status,b.location].some(x=>x.toLowerCase().includes(q));
    });

    rows.sort((a,b)=>{
      const dir = traceSortDir==='asc' ? 1 : -1;
      let x=a[traceSortKey], y=b[traceSortKey];
      if(traceSortKey==='timestamp'){ // compare as time
        return (new Date(x)-new Date(y))*dir;
      }
      return (''+x).localeCompare((''+y))*dir;
    });
    if(traceSortDir==='desc') rows.reverse();
    return rows;
  }

  function renderTraceTable(){
    const rows = getFilteredBatches();
    const total = rows.length;
    const totalPages = Math.max(1, Math.ceil(total/tracePageSize));
    tracePage = Math.min(tracePage, totalPages);

    const start = (tracePage-1)*tracePageSize;
    const pageRows = rows.slice(start, start+tracePageSize);

    const tbody = $('#traceTableBody');
    tbody.innerHTML = '';
    pageRows.forEach(row=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><a href="#" class="link-primary" data-batch="${row.batchId}">${row.batchId}</a></td>
        <td>${row.manufacturer}</td>
        <td><span class="${badgeByStatus(row.status)}">${row.status}</span></td>
        <td>${row.location}</td>
        <td><span class="text-muted">${row.timestamp}</span></td>`;
      tbody.appendChild(tr);
    });

    $('#tracePagerInfo').textContent = Showing ${start+1}-${Math.min(start+tracePageSize,total)} of ${total};
    $('#tracePrev').disabled = tracePage<=1;
    $('#traceNext').disabled = tracePage>=totalPages;

    // Hook row links for modal
    $$('#traceTableBody a[data-batch]').forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault();
        openBatchModal(a.dataset.batch);
      });
    });
    
    // Update sort icons
    $$('#traceTable thead th.sortable').forEach(th => {
        const icon = th.querySelector('i');
        if (icon) {
            icon.className = 'bi';
            if (th.dataset.key === traceSortKey) {
                icon.classList.add(traceSortDir === 'asc' ? 'bi-sort-up-alt' : 'bi-sort-down-alt');
            } else {
                 icon.classList.add('bi-sort');
            }
        }
    });
  }

  function badgeByStatus(status){
    switch(status){
      case 'FDA Approved': return 'badge bg-success-subtle text-success-emphasis';
      case 'Awaiting Approval': return 'badge bg-warning-subtle text-warning-emphasis';
      case 'In Transit': return 'badge bg-info-subtle text-info-emphasis';
      case 'At Pharmacy': return 'badge bg-primary-subtle text-primary-emphasis';
      case 'Registered': return 'badge bg-secondary-subtle text-secondary-emphasis';
      default: return 'badge bg-light text-dark';
    }
  }

  // Events
  $('#traceSearch').addEventListener('input', (e)=>{ traceQuery=e.target.value; tracePage=1; renderTraceTable(); });
  $('#tracePageSize').addEventListener('change', (e)=>{ tracePageSize=parseInt(e.target.value,10)||10; tracePage=1; renderTraceTable(); });
  $('#tracePrev').addEventListener('click', ()=>{ tracePage=Math.max(1, tracePage-1); renderTraceTable(); });
  $('#traceNext').addEventListener('click', ()=>{ tracePage=tracePage+1; renderTraceTable(); });
  $$('#traceTable thead th.sortable').forEach(th=>{
    th.style.cursor='pointer';
    th.addEventListener('click', ()=>{
      const key = th.dataset.key;
      if(traceSortKey===key){ traceSortDir = (traceSortDir==='asc'?'desc':'asc'); }
      else { traceSortKey=key; traceSortDir='asc'; }
      renderTraceTable();
    });
  });

  // ---------- Batch Modal ----------
  function openBatchModal(batchId){
    const b = batches.find(x=>x.batchId===batchId);
    if(!b){ toast('Batch not found','warning'); return; }
    $('#modalBatchId').textContent = b.batchId;
    $('#modalManufacturer').textContent = b.manufacturer;
    $('#modalStatus').textContent = b.status;

    const tl = $('#modalTimeline');
    tl.innerHTML = '';
    const steps = fakeJourneyFor(b);
    steps.forEach(st=>{
      const li = document.createElement('li');
      li.className = 'list-group-item';
      li.innerHTML = `
        <span class="step-dot" style="background:${st.color}"></span>
        <div>
          <div class="fw-semibold">${st.title}</div>
          <div class="text-muted text-xxs">${st.when}</div>
          <div class="text-secondary">${st.note}</div>
        </div>
      `;
      tl.appendChild(li);
    });

    const modal = new bootstrap.Modal($('#batchModal'));
    modal.show();
    log(Opened batch modal for ${batchId});
  }

  function fakeJourneyFor(b){
    // Generate a short static-ish path for demo
    const base = [
      { title:'Registered on Ledger', note:Manufacturer: ${b.manufacturer}, color:'#6c757d' },
      { title:'FDA Review',          note:'Regulatory screening in progress', color:'#ffc107' },
      { title:'Cold Chain Handover', note:'Handover to Distributor', color:'#0dcaf0' },
      { title:'Arrived at Pharmacy', note:'Ready for dispensing', color:'#0d6efd' },
    ];
    const now = new Date(b.timestamp);
    return base.map((s,i)=>({ ...s, when: fmtTime(new Date(now.getTime() + i*3600*1000)) }));
  }

  // ---------- IoT Charts (live simulation) ----------
  const iot = {
    labels: [],
    temp: [],
    humid: [],
    press: [],
    maxPoints: 40
  };
  let charts = { temp:null, humid:null, press:null };

  function makeLineChart(ctx, label, color){
    return new Chart(ctx, {
      type:'line',
      data:{
        labels: iot.labels,
        datasets:[{
          label,
          data: iot[label.toLowerCase()],
          fill: true,
          borderColor: color,
          backgroundColor: color.replace('rgb(','rgba(').replace(')','), 0.2)'), // lighter fill
          borderWidth: 2,
          pointRadius: 0,
          tension: .35
        }]
      },
      options:{
        animation:false,
        responsive:true,
        scales:{
          x:{ display:false },
          y:{ ticks:{ callback:v=>v } }
        },
        plugins:{ legend:{ display:false } }
      }
    });
  }
// Chart color mapping for Bootstrap themes
const chartColors = {
    temp: 'rgb(13, 110, 253)', // Blue (Primary)
    humid: 'rgb(255, 193, 7)', // Yellow (Warning)
    press: 'rgb(108, 117, 125)' // Gray (Secondary)
};

  function initCharts(){
    charts.temp = makeLineChart($('#section-iot #tempChart'), 'Temp', chartColors.temp);
    charts.humid = makeLineChart($('#section-iot #humidChart'), 'Humid', chartColors.humid);
    charts.press = makeLineChart($('#section-iot #pressChart'), 'Press', chartColors.press);
    // Overwrite the overview chart with the same settings for demo consistency
    charts.tempOverview = makeLineChart($('#section-overview #tempChart'), 'Temp', chartColors.temp);
    // Seed with a few points
    for(let i=0;i<10;i++) pushIotPoint();
    updateCharts();
  }

  function pushIotPoint(){
    const tLast = iot.temp.at(-1) ?? 5.0;
    const nextT = Math.max(1, Math.min(12, tLast + (Math.random()-0.5)*0.7));
    const nextH = 45 + (Math.random()*10-5);
    const nextP = 1005 + (Math.random()*8-4);

    iot.labels.push(new Date().toLocaleTimeString());
    iot.temp.push(Number(nextT.toFixed(1)));
    iot.humid.push(Number(nextH.toFixed(1)));
    iot.press.push(Number(nextP.toFixed(1)));

    // clamp size
    ['labels','temp','humid','press'].forEach(k=>{
      if(iot[k].length>iot.maxPoints) iot[k].shift();
    });

    // alert on temperature breach
    if(nextT>8 || nextT<2){
      const id = Math.max(0,...alerts.map(a=>a.id))+1;
      const entry = { id, severity:'Critical', status:'Pending', title:'Temperature Breach',
        detail:Auto-detected: ${nextT.toFixed(1)}°C (safe 2–8°C)., when: fmtTime() };
      alerts.unshift(entry);
      renderAlerts();
      renderKpis();
      toast(CRITICAL: ${entry.detail},'danger');
      log(Temp anomaly detected: ${entry.detail}, 'warn');
    }
  }

  function updateCharts(){
    charts.temp.update();
    charts.humid.update();
    charts.press.update();
    charts.tempOverview.update();
  }

  // Live loop
  setInterval(()=>{ pushIotPoint(); updateCharts(); }, 4000);

  // ---------- Alerts ----------
  function renderAlerts(){
    const filter = $('#alertsFilter').value;
    const list = $('#alertsList');
    list.innerHTML = '';

    const rows = alerts.filter(a => filter==='All' ? true : a.status===filter);
    if(rows.length===0){
      list.innerHTML = <li class="list-group-item text-secondary">No alerts found for current filter.</li>;
      return;
    }
    rows.forEach(a=>{
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex align-items-center justify-content-between';
      li.innerHTML = `
        <div>
          <div class="fw-semibold">
            <span class="badge me-2 ${badgeFromSeverity(a.severity)}">${a.severity}</span>
            ${a.title}
          </div>
          <div class="text-secondary small">${a.detail}</div>
          <div class="text-muted text-xxs">${a.when} • Status: ${a.status}</div>
        </div>
        <div class="btn-group btn-group-sm">
          ${a.status==='Pending' ? <button class="btn btn-outline-success" data-act="resolve" data-id="${a.id}"><i class="bi bi-check2"></i> Resolve</button>:''}
          <button class="btn btn-outline-danger" data-act="remove" data-id="${a.id}"><i class="bi bi-x"></i></button>
        </div>`;
      list.appendChild(li);
    });

    // Wire actions
    $$('button[data-act="resolve"]', list).forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = Number(btn.dataset.id);
        const item = alerts.find(a=>a.id===id);
        if(item){ item.status='Resolved'; toast(Alert #${id} resolved,'success'); log(Alert ${id} marked resolved); renderAlerts(); renderKpis(); }
      });
    });
    $$('button[data-act="remove"]', list).forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = Number(btn.dataset.id);
        alerts = alerts.filter(a=>a.id!==id);
        toast(Alert #${id} removed,'secondary');
        log(Alert ${id} removed);
        renderAlerts();
        renderKpis();
      });
    });
  }

  function badgeFromSeverity(s){
    switch(s){
      case 'Critical': return 'bg-danger';
      case 'High': return 'bg-warning text-dark';
      case 'Medium': return 'bg-info text-dark';
      default: return 'bg-secondary';
    }
  }

  $('#alertsFilter').addEventListener('change', renderAlerts);

  // ---------- FDA Approvals ----------
  function renderApprovals(){
    const tbody = $('#approvalHistory');
    tbody.innerHTML = '';
    approvalHistory.forEach(r=>{
      const tr = document.createElement('tr');
      const statusBadge = r.status==='Approved'
        ? '<span class="badge bg-success">Approved</span>'
        : '<span class="badge bg-warning text-dark">Pending</span>';
      tr.innerHTML = `
        <td>${r.batchId}</td>
        <td>${r.requester}</td>
        <td>${statusBadge}</td>
        <td class="text-muted">${r.timestamp}</td>`;
      tbody.appendChild(tr);
    });
  }

  // ---------- Reports ----------
  function download(filename, content, mime='text/plain'){
    const blob = new Blob([content], {type:mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    setTimeout(()=> URL.revokeObjectURL(url), 1500);
  }

  $('#btnDownloadShipments').addEventListener('click', ()=>{
    const header = ['Batch ID','Manufacturer','Status','Location','Timestamp'];
    const rows = batches.map(b=>[b.batchId,b.manufacturer,b.status,b.location,b.timestamp]);
    const csv = [header, ...rows].map(r=>r.map(x=>"${String(x).replace(/"/g,'""')}").join(',')).join('\n');
    download('shipment_summary.csv', csv, 'text/csv');
    toast('Shipment summary (CSV) downloaded','primary'); log('Downloaded shipment_summary.csv');
  });

  $('#btnDownloadIot').addEventListener('click', ()=>{
    const payload = {
      generatedAt: fmtTime(),
      metrics: iot.labels.map((t,i)=>({ t, temp:iot.temp[i], humid:iot.humid[i], press:iot.press[i] }))
    };
    download('iot_metrics.json', JSON.stringify(payload,null,2), 'application/json');
    toast('IoT metrics (JSON) downloaded','primary'); log('Downloaded iot_metrics.json');
  });

  $('#btnDownloadCompliance').addEventListener('click', ()=>{
    // Simple text-based pseudo-PDF (let the OS open with default app). For real PDF use jsPDF.
    const lines = [
      'PharmaChain — Monthly Compliance Report',
      Generated: ${fmtTime()},
      '',
      Total Batches: ${batches.length},
      FDA Approved: ${batches.filter(b=>b.status==='FDA Approved').length},
      Pending Approvals: ${approvalHistory.filter(a=>a.status==='Pending').length},
      Active Alerts: ${alerts.filter(a=>a.status==='Pending').length},
      '',
      '— End of Report —'
    ].join('\n');
    download('compliance_report.txt', lines, 'text/plain');
    toast('Compliance report generated','primary'); log('Downloaded compliance_report.txt');
  });

  // ---------- Role Switching ----------
  const roleEffects = {
    'FDA': { kpiLabelApprovals:'FDA Approvals Pending', kpiLabelTransit:'Drugs in Transit' },
    'Manufacturer': { kpiLabelApprovals:'Batches Awaiting QA', kpiLabelTransit:'Shipments Dispatched' },
    'Distributor': { kpiLabelApprovals:'Confirmations Pending', kpiLabelTransit:'Active Routes' },
    'Pharmacy': { kpiLabelApprovals:'Incoming Deliveries', kpiLabelTransit:'En-route Packages' },
  };

  $('#roleSwitcher').addEventListener('change', (e)=>{
    const role = e.target.value;
    $('#roleTop').textContent = role;
    const map = roleEffects[role] || roleEffects['FDA'];
    $('#kpiLabelApprovals').textContent = map.kpiLabelApprovals;
    $('#kpiLabelTransit').textContent = map.kpiLabelTransit;
    toast(Switched role to ${role}, 'secondary');
    log(Role changed to ${role});
  });

  // ---------- Initialization ----------
  function init(){
    setActiveSection('overview');
    renderKpis();
    renderTraceTable();
    renderApprovals();
    renderAlerts();
    initCharts();

    // Default log lines
    log('Starting PharmaChain Kernel...');
    log('Block validation service connected.');
    log('IoT stream simulator running @4s cadence.');
    log('Dashboard initialized. Ready.');
  }

  // Boot
  document.addEventListener('DOMContentLoaded', init);
})();
    </script>
</body>
</html>